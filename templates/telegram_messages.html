{% extends "base.html" %}

{% block title %}محادثة {{ user.first_name }} - مؤسسة الحبيب الطبية{% endblock %}

{% block head %}
<style>
    .chat-container {
        height: 600px;
        overflow-y: auto;
        padding: 20px;
        background: #1a1d20;
        border-radius: 10px;
    }
    .message {
        margin-bottom: 20px;
        max-width: 80%;
    }
    .message-user {
        margin-right: auto;
    }
    .message-assistant {
        margin-left: auto;
    }
    .message-content {
        padding: 12px 16px;
        border-radius: 15px;
        position: relative;
    }
    .message-user .message-content {
        background-color: #0d6efd;
        color: white;
        border-bottom-right-radius: 2px;
    }
    .message-assistant .message-content {
        background-color: #2c3034;
        color: #e9ecef;
        border-bottom-left-radius: 2px;
        border: 1px solid #495057;
    }
    .message-time {
        font-size: 0.75rem;
        margin-top: 5px;
        color: #adb5bd;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-8">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('chat.telegram_admin') }}">تحكم تلجرام</a></li>
                    <li class="breadcrumb-item active" aria-current="page">سجل المحادثة</li>
                </ol>
            </nav>
            <h3><i class="fas fa-comments text-primary me-2"></i> محادثة: {{ user.first_name }} {{ user.last_name or '' }}</h3>
        </div>
        <div class="col-md-4 text-end">
            <div class="card bg-dark border-secondary">
                <div class="card-body py-2">
                    <small class="text-muted d-block">رقم الهاتف</small>
                    <strong>{{ user.phone_number or 'غير متوفر' }}</strong>
                </div>
            </div>
        </div>
    </div>

    <div class="chat-container shadow-lg" id="chatContainer">
        {% for msg in messages %}
        <div class="message {% if msg.role == 'user' %}message-user text-end{% else %}message-assistant text-start{% endif %}">
            <div class="d-inline-block text-start">
                <div class="message-content shadow-sm">
                    {{ msg.content | replace('\n', '<br>') | safe }}
                </div>
                <div class="message-time">
                    {{ msg.created_at.strftime('%H:%M - %Y/%m/%d') }}
                </div>
            </div>
        </div>
        {% else %}
        <div class="text-center py-5 text-muted">
            <p>لا توجد رسائل مسجلة لهذه المحادثة.</p>
        </div>
        {% endfor %}
    </div>
    
    <div class="mt-4 text-center">
        <a href="{{ url_for('chat.telegram_admin') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-right me-1"></i> العودة لقائمة العملاء
        </a>
    </div>
</div>

{% block scripts %}
<script>
    // Scroll to bottom of chat container
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.scrollTop = chatContainer.scrollHeight;
</script>
{% endblock %}
{% endblock %}
